version: "3"

vars:
  NPX: '{{.NPX | default "npx"}}'
  NPM: '{{.NPM | default "pnpm"}}'

tasks:
  prepare:
    cmds:
      - "{{.NPM}} i"
      - touch node_modules/.installed
    sources:
      - package.json
      - package-lock.json
      - pnpm-lock.yaml
    status:
      - test -f node_modules/.installed
  build:
    deps: [prepare]
    cmds:
      - >-
        {{.NPX}} protoc
        -I ../../src
        --plugin=./node_modules/.bin/protoc-gen-ts_proto{{if eq OS "windows"}}.cmd{{end}}
        --ts_proto_opt=oneof=unions
        --ts_proto_out=. ../../src/*.proto
    sources:
      - "../../src/**/*.proto"
    generates:
      - "*.ts"
      - exclude: "*.spec.ts"
  test:
    deps: [build]
    cmd: "{{.NPX}} vitest run"
